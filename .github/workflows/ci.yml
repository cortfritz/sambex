name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.18"
  OTP_VERSION: "27"

jobs:
  test:
    name: Test (Elixir ${{ matrix.elixir }} / OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        elixir: ["1.18", "1.19"]
        otp: ["27", "28"]
        include:
          - elixir: "1.18"
            otp: "27"
            coverage: true
            quality: true
        exclude:
          - elixir: "1.19"
            otp: "27"
          - elixir: "1.18"
            otp: "28"

    services:
      samba:
        image: dperson/samba
        ports:
          - 139:139
          - 445:445
        options: >-
          --health-cmd "pgrep smbd"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 6
          --health-start-period 30s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsmbclient-dev smbclient

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: deps-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            deps-${{ runner.os }}-${{ matrix.elixir }}-${{ matrix.otp }}-
            deps-${{ runner.os }}-

      - name: Install dependencies
        run: mix deps.get && mix zig.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Compile with warnings as errors
        run: mix compile --warnings-as-errors

      - name: Run unit tests
        run: mix test --exclude integration

      - name: Configure Samba for integration tests
        run: |
          # Wait for Samba to start
          timeout 60 bash -c 'until nc -z localhost 445; do sleep 1; done'

          # Get container ID and configure
          CONTAINER_ID=$(docker ps -q --filter ancestor=dperson/samba)
          if [ ! -z "$CONTAINER_ID" ]; then
            echo "Configuring Samba container: $CONTAINER_ID"

            # Add users and shares
            docker exec $CONTAINER_ID samba.sh -u "example1;badpass"
            docker exec $CONTAINER_ID samba.sh -u "example2;badpass"
            docker exec $CONTAINER_ID samba.sh -s "public;/tmp/public;no;no;yes;example1;none;none"
            docker exec $CONTAINER_ID samba.sh -s "private;/tmp/private;no;no;no;example2;none;none"

            # Disable VFS objects that prevent deletion
            docker exec $CONTAINER_ID samba.sh -g "vfs objects = "

            # Create directories
            docker exec $CONTAINER_ID mkdir -p /tmp/public /tmp/private
            docker exec $CONTAINER_ID chmod 777 /tmp/public /tmp/private

            # Restart Samba
            docker exec $CONTAINER_ID supervisorctl restart smbd

            # Wait for restart
            sleep 10
          else
            echo "Warning: Samba container not found"
          fi

      - name: Test SMB connectivity
        run: |
          # Test basic connectivity
          timeout 30 bash -c 'until smbclient -L localhost -N 2>/dev/null; do
            echo "Waiting for SMB server..."
            sleep 2
          done'

          # Test with credentials
          smbclient //localhost/public -U example1%badpass -c "ls" || echo "Warning: SMB test failed"

      - name: Run integration tests
        run: |
          if nc -z localhost 445; then
            echo "SMB server is available, running integration tests..."
            mix test --only integration
          else
            echo "SMB server not available, skipping integration tests"
          fi

      - name: Run all tests
        run: mix test

      - name: Generate coverage
        if: matrix.coverage
        run: mix test --cover
        continue-on-error: true

      - name: Check code quality
        if: matrix.quality
        run: |
          mix credo --strict || echo "Credo check completed with warnings"
          mix deps.audit || echo "Deps audit completed"
        continue-on-error: true

      - name: Build docs
        if: matrix.quality
        run: mix docs
        continue-on-error: true

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsmbclient-dev

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            deps
            _build
          key: deps-prod-${{ runner.os }}-${{ hashFiles('**/mix.lock') }}

      - name: Install dependencies
        run: mix deps.get --only prod

      - name: Build release
        run: MIX_ENV=prod mix compile

      - name: Check hex package
        run: mix hex.build
        continue-on-error: true
